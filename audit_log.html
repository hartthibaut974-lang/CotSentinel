{% extends "base.html" %}

{% block title %}Audit Log - CoT Server Admin{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">üìú Audit Log</h1>

<!-- Stats Cards -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="totalEvents">-</div>
        <div class="stat-label">Events (7 days)</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="successfulLogins">-</div>
        <div class="stat-label">Successful Logins</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-value" id="failedLogins">-</div>
        <div class="stat-label">Failed Logins</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-value" id="criticalEvents">-</div>
        <div class="stat-label">Critical Events</div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <h2>üîç Filters</h2>
    <div class="filter-grid">
        <div class="filter-group">
            <label>Category</label>
            <select id="filterCategory" class="form-control">
                <option value="">All Categories</option>
                <option value="authentication">Authentication</option>
                <option value="user_management">User Management</option>
                <option value="certificate">Certificates</option>
                <option value="configuration">Configuration</option>
                <option value="backup">Backup</option>
                <option value="security">Security</option>
                <option value="system">System</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Level</label>
            <select id="filterLevel" class="form-control">
                <option value="">All Levels</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="critical">Critical</option>
            </select>
        </div>
        <div class="filter-group">
            <label>User</label>
            <input type="text" id="filterUser" class="form-control" placeholder="Username">
        </div>
        <div class="filter-group">
            <label>Date Range</label>
            <input type="date" id="filterStartDate" class="form-control">
            <span style="margin: 0 0.5rem;">to</span>
            <input type="date" id="filterEndDate" class="form-control">
        </div>
    </div>
    <div class="button-group" style="margin-top: 1rem;">
        <button class="btn btn-primary" onclick="loadAuditLogs()">Apply Filters</button>
        <button class="btn" onclick="clearFilters()">Clear</button>
        <button class="btn" onclick="exportLogs()">üì• Export</button>
    </div>
</div>

<!-- Audit Log Table -->
<div class="card">
    <h2>üìã Event Log</h2>
    <div id="auditLogTable">
        <div class="loading">Loading audit logs...</div>
    </div>
    
    <!-- Pagination -->
    <div id="pagination" class="pagination" style="display: none;">
        <button class="btn" id="prevPage" onclick="changePage(-1)">‚Üê Previous</button>
        <span id="pageInfo">Page 1</span>
        <button class="btn" id="nextPage" onclick="changePage(1)">Next ‚Üí</button>
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-group label {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .form-control {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .button-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .audit-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .audit-table th,
    .audit-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .audit-table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 0.85rem;
        color: #666;
    }
    
    .audit-table tr:hover {
        background: #f8f9fa;
    }
    
    .level-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .level-info { background: #e3f2fd; color: #1565c0; }
    .level-warning { background: #fff3e0; color: #e65100; }
    .level-critical { background: #ffebee; color: #c62828; }
    
    .category-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        background: #f0f0f0;
        color: #666;
    }
    
    .success-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .success-indicator.success { background: #4caf50; }
    .success-indicator.failure { background: #f44336; }
    
    .timestamp {
        font-size: 0.85rem;
        color: #666;
        white-space: nowrap;
    }
    
    .ip-address {
        font-family: monospace;
        font-size: 0.85rem;
    }
    
    .details-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.85rem;
        color: #666;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }
    
    #pageInfo {
        font-weight: 500;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #888;
    }
</style>

<script>
    let currentPage = 0;
    const pageSize = 50;
    let totalRecords = 0;
    
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadAuditLogs();
    });
    
    function loadStats() {
        fetch('/api/audit/stats?days=7')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('totalEvents').textContent = stats.total_events || 0;
                    document.getElementById('successfulLogins').textContent = stats.successful_logins || 0;
                    document.getElementById('failedLogins').textContent = stats.failed_logins || 0;
                    document.getElementById('criticalEvents').textContent = stats.by_level?.critical || 0;
                }
            });
    }
    
    function loadAuditLogs() {
        const category = document.getElementById('filterCategory').value;
        const level = document.getElementById('filterLevel').value;
        const user = document.getElementById('filterUser').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        let url = `/api/audit/logs?limit=${pageSize}&offset=${currentPage * pageSize}`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (level) url += `&level=${encodeURIComponent(level)}`;
        if (user) url += `&user=${encodeURIComponent(user)}`;
        if (startDate) url += `&start_date=${startDate}T00:00:00`;
        if (endDate) url += `&end_date=${endDate}T23:59:59`;
        
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    totalRecords = data.total;
                    renderAuditLogs(data.logs);
                    updatePagination();
                }
            })
            .catch(err => {
                document.getElementById('auditLogTable').innerHTML = 
                    '<div class="alert alert-error">Failed to load audit logs</div>';
            });
    }
    
    function renderAuditLogs(logs) {
        const container = document.getElementById('auditLogTable');
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>No audit events found</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Level</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Category</th>
                        <th>Target</th>
                        <th>Status</th>
                        <th>IP Address</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        logs.forEach(log => {
            const timestamp = new Date(log.timestamp).toLocaleString();
            const levelClass = `level-${log.level}`;
            const successClass = log.success ? 'success' : 'failure';
            
            html += `
                <tr>
                    <td class="timestamp">${timestamp}</td>
                    <td><span class="level-badge ${levelClass}">${log.level}</span></td>
                    <td>${log.user || '-'}</td>
                    <td>${log.action}</td>
                    <td><span class="category-badge">${log.category}</span></td>
                    <td>${log.target || '-'}</td>
                    <td><span class="success-indicator ${successClass}" title="${log.success ? 'Success' : 'Failed'}"></span></td>
                    <td class="ip-address">${log.ip_address || '-'}</td>
                    <td class="details-cell" title="${log.details || ''}">${log.details || '-'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(totalRecords / pageSize);
        
        if (totalRecords <= pageSize) {
            pagination.style.display = 'none';
            return;
        }
        
        pagination.style.display = 'flex';
        document.getElementById('pageInfo').textContent = 
            `Page ${currentPage + 1} of ${totalPages} (${totalRecords} total)`;
        
        document.getElementById('prevPage').disabled = currentPage === 0;
        document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;
    }
    
    function changePage(delta) {
        const totalPages = Math.ceil(totalRecords / pageSize);
        const newPage = currentPage + delta;
        
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadAuditLogs();
        }
    }
    
    function clearFilters() {
        document.getElementById('filterCategory').value = '';
        document.getElementById('filterLevel').value = '';
        document.getElementById('filterUser').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        currentPage = 0;
        loadAuditLogs();
    }
    
    function exportLogs() {
        window.location.href = '/api/audit/export';
    }
</script>
{% endblock %}
