{% extends "base.html" %}

{% block title %}Backup & Restore - CoT Server Admin{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">ğŸ’¾ Backup & Restore</h1>

<!-- Create Backup Card -->
<div class="card">
    <h2>ğŸ“¦ Create New Backup</h2>
    <p style="color: #666; margin-bottom: 1.5rem;">
        Create a complete backup of your TAK Server configuration, certificates, and database.
    </p>
    
    <div class="form-group">
        <label for="backupName">Backup Name (optional):</label>
        <input type="text" id="backupName" class="form-control" placeholder="e.g., before-upgrade">
    </div>
    
    <div class="backup-options">
        <h3>Include in Backup:</h3>
        <div class="checkbox-group">
            <label class="checkbox-item">
                <input type="checkbox" id="includeCerts" checked>
                <span class="checkbox-label">
                    ğŸ” Certificates
                    <small>CA, client certs, keys, revocation list</small>
                </span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="includeConfig" checked>
                <span class="checkbox-label">
                    âš™ï¸ Configuration
                    <small>CoreConfig.xml, credentials, users</small>
                </span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="includeDb" checked>
                <span class="checkbox-label">
                    ğŸ—„ï¸ Database
                    <small>PostgreSQL takserver database</small>
                </span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="includePackages">
                <span class="checkbox-label">
                    ğŸ“¦ Data Packages
                    <small>Uploaded .zip/.dpk files</small>
                </span>
            </label>
        </div>
    </div>
    
    <div class="button-group" style="margin-top: 1.5rem;">
        <button class="btn btn-primary" onclick="createBackup()" id="createBackupBtn">
            ğŸ’¾ Create Backup
        </button>
    </div>
    
    <div id="backupProgress" class="progress-container" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill indeterminate"></div>
        </div>
        <p id="backupStatus" class="progress-status">Creating backup...</p>
    </div>
</div>

<!-- Upload Backup Card -->
<div class="card">
    <h2>ğŸ“¤ Upload Backup</h2>
    <p style="color: #666; margin-bottom: 1rem;">
        Upload a backup file from another system or previous export.
    </p>
    
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“</div>
        <p>Drag and drop a backup file here, or click to select</p>
        <p style="font-size: 0.85rem; color: #888;">Supported format: .zip</p>
        <input type="file" id="fileInput" accept=".zip" style="display: none;">
    </div>
</div>

<!-- Available Backups Card -->
<div class="card">
    <h2>ğŸ“‹ Available Backups</h2>
    <div id="backupsList">
        <div class="loading">Loading backups...</div>
    </div>
</div>

<!-- Restore Modal -->
<div id="restoreModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h3>ğŸ”„ Restore from Backup</h3>
        <p id="restoreFilename" style="color: #666; margin-bottom: 1rem;"></p>
        
        <div class="alert alert-warning">
            âš ï¸ <strong>Warning:</strong> Restoring will overwrite current data. 
            A pre-restore backup will be created automatically.
        </div>
        
        <div class="backup-options" style="margin: 1rem 0;">
            <h4>Restore Options:</h4>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="restoreCerts" checked>
                    <span class="checkbox-label">ğŸ” Certificates</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="restoreConfig" checked>
                    <span class="checkbox-label">âš™ï¸ Configuration</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="restoreDb" checked>
                    <span class="checkbox-label">ğŸ—„ï¸ Database</span>
                </label>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-danger" onclick="confirmRestore()">ğŸ”„ Restore</button>
            <button class="btn" onclick="hideModal('restoreModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Backup Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>ğŸ“‹ Backup Details</h3>
        <div id="backupDetails">
            <div class="loading">Loading...</div>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="hideModal('detailsModal')">Close</button>
        </div>
    </div>
</div>

<style>
    .backup-options h3, .backup-options h4 {
        font-size: 1rem;
        color: #333;
        margin-bottom: 0.75rem;
    }
    
    .checkbox-group {
        display: grid;
        gap: 0.75rem;
    }
    
    .checkbox-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .checkbox-item:hover {
        background: #e9ecef;
    }
    
    .checkbox-item input[type="checkbox"] {
        margin-top: 0.25rem;
        width: 18px;
        height: 18px;
    }
    
    .checkbox-label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .checkbox-label small {
        color: #666;
        font-size: 0.85rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        max-width: 400px;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    
    .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .progress-container {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .progress-bar {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s;
    }
    
    .progress-fill.indeterminate {
        width: 30%;
        animation: indeterminate 1.5s infinite ease-in-out;
    }
    
    @keyframes indeterminate {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(400%); }
    }
    
    .progress-status {
        text-align: center;
        margin-top: 0.5rem;
        color: #666;
    }
    
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafafa;
    }
    
    .upload-area:hover,
    .upload-area.dragover {
        border-color: #667eea;
        background: #f0f3ff;
    }
    
    .upload-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
    }
    
    .backup-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }
    
    .backup-item:hover {
        background: #f8f9fa;
    }
    
    .backup-item:last-child {
        border-bottom: none;
    }
    
    .backup-icon {
        font-size: 2rem;
        margin-right: 1rem;
    }
    
    .backup-info {
        flex: 1;
    }
    
    .backup-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .backup-meta {
        font-size: 0.85rem;
        color: #666;
    }
    
    .backup-contents {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .backup-badge {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        background: #e0e0e0;
        border-radius: 4px;
    }
    
    .backup-badge.included {
        background: #d4edda;
        color: #155724;
    }
    
    .backup-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-icon {
        padding: 0.5rem;
        border: none;
        background: #f0f0f0;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
    }
    
    .btn-icon:hover {
        background: #e0e0e0;
    }
    
    .btn-icon.danger:hover {
        background: #ffe0e0;
        color: #d32f2f;
    }
    
    .btn-icon.restore:hover {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #888;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .btn-danger {
        background: #d32f2f;
    }
    
    .btn-danger:hover {
        background: #b71c1c;
    }
    
    .details-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 0.5rem 1rem;
        margin-bottom: 1rem;
    }
    
    .details-label {
        font-weight: 600;
        color: #666;
    }
    
    .details-value {
        color: #333;
    }
    
    .file-list {
        max-height: 200px;
        overflow-y: auto;
        background: #f5f5f5;
        border-radius: 4px;
        padding: 0.5rem;
        font-family: monospace;
        font-size: 0.85rem;
    }
</style>

<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    // Load backups on page load
    document.addEventListener('DOMContentLoaded', loadBackups);
    
    // Upload area handlers
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            uploadBackup(e.dataTransfer.files[0]);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            uploadBackup(e.target.files[0]);
        }
    });
    
    function createBackup() {
        const btn = document.getElementById('createBackupBtn');
        const progress = document.getElementById('backupProgress');
        const status = document.getElementById('backupStatus');
        
        btn.disabled = true;
        progress.style.display = 'block';
        status.textContent = 'Creating backup...';
        
        const options = {
            name: document.getElementById('backupName').value,
            include_certificates: document.getElementById('includeCerts').checked,
            include_config: document.getElementById('includeConfig').checked,
            include_database: document.getElementById('includeDb').checked,
            include_packages: document.getElementById('includePackages').checked
        };
        
        fetch('/api/backups/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(options)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert(`Backup created: ${data.filename} (${data.size_human})`, 'success');
                loadBackups();
                
                // Auto-download the backup
                window.location.href = `/api/backups/download/${data.filename}`;
            } else {
                showAlert(data.error || 'Backup failed', 'error');
            }
        })
        .catch(err => {
            showAlert('Backup failed: ' + err.message, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            progress.style.display = 'none';
            document.getElementById('backupName').value = '';
        });
    }
    
    function uploadBackup(file) {
        if (!file.name.endsWith('.zip')) {
            showAlert('Invalid file type. Only .zip files allowed.', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/backups/upload', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert(`Backup uploaded: ${data.filename}`, 'success');
                loadBackups();
            } else {
                showAlert(data.error || 'Upload failed', 'error');
            }
        })
        .catch(err => {
            showAlert('Upload failed: ' + err.message, 'error');
        });
        
        fileInput.value = '';
    }
    
    function loadBackups() {
        fetch('/api/backups/list')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderBackups(data.backups);
                } else {
                    document.getElementById('backupsList').innerHTML = 
                        '<div class="alert alert-error">Failed to load backups</div>';
                }
            })
            .catch(err => {
                document.getElementById('backupsList').innerHTML = 
                    '<div class="alert alert-error">Error loading backups</div>';
            });
    }
    
    function renderBackups(backups) {
        const container = document.getElementById('backupsList');
        
        if (backups.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’¾</div>
                    <p>No backups available</p>
                    <p style="font-size: 0.9rem;">Create your first backup to protect your TAK Server data</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        backups.forEach(backup => {
            const date = new Date(backup.created).toLocaleString();
            const manifest = backup.manifest || {};
            const contents = manifest.contents || {};
            
            html += `
                <div class="backup-item">
                    <div class="backup-icon">ğŸ’¾</div>
                    <div class="backup-info">
                        <div class="backup-name">${backup.filename}</div>
                        <div class="backup-meta">${backup.size_human} â€¢ ${date}</div>
                        <div class="backup-contents">
                            ${contents.certificates ? '<span class="backup-badge included">ğŸ” Certs</span>' : ''}
                            ${contents.config ? '<span class="backup-badge included">âš™ï¸ Config</span>' : ''}
                            ${contents.database ? '<span class="backup-badge included">ğŸ—„ï¸ DB</span>' : ''}
                            ${contents.packages ? '<span class="backup-badge included">ğŸ“¦ Packages</span>' : ''}
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn-icon" onclick="showDetails('${backup.filename}')" title="Details">
                            â„¹ï¸
                        </button>
                        <button class="btn-icon" onclick="downloadBackup('${backup.filename}')" title="Download">
                            â¬‡ï¸
                        </button>
                        <button class="btn-icon restore" onclick="showRestoreModal('${backup.filename}')" title="Restore">
                            ğŸ”„
                        </button>
                        <button class="btn-icon danger" onclick="deleteBackup('${backup.filename}')" title="Delete">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function downloadBackup(filename) {
        window.location.href = `/api/backups/download/${encodeURIComponent(filename)}`;
    }
    
    function deleteBackup(filename) {
        if (!confirm(`Delete backup "${filename}"?\n\nThis cannot be undone.`)) {
            return;
        }
        
        fetch(`/api/backups/delete/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('Backup deleted', 'success');
                loadBackups();
            } else {
                showAlert(data.error || 'Delete failed', 'error');
            }
        });
    }
    
    let currentRestoreFile = '';
    
    function showRestoreModal(filename) {
        currentRestoreFile = filename;
        document.getElementById('restoreFilename').textContent = `File: ${filename}`;
        showModal('restoreModal');
    }
    
    function confirmRestore() {
        if (!currentRestoreFile) return;
        
        const options = {
            filename: currentRestoreFile,
            restore_certificates: document.getElementById('restoreCerts').checked,
            restore_config: document.getElementById('restoreConfig').checked,
            restore_database: document.getElementById('restoreDb').checked
        };
        
        hideModal('restoreModal');
        
        // Show progress
        showAlert('Restoring backup... Please wait.', 'info');
        
        fetch('/api/backups/restore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(options)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                let msg = `Restore completed: ${data.restored.length} items restored.`;
                if (data.errors && data.errors.length > 0) {
                    msg += ` ${data.errors.length} warnings.`;
                }
                if (data.restart_required) {
                    msg += '\n\nRestart TAK Server to apply changes.';
                }
                showAlert(msg, 'success');
            } else {
                showAlert(data.error || 'Restore failed', 'error');
            }
        })
        .catch(err => {
            showAlert('Restore failed: ' + err.message, 'error');
        });
    }
    
    function showDetails(filename) {
        document.getElementById('backupDetails').innerHTML = '<div class="loading">Loading...</div>';
        showModal('detailsModal');
        
        // Find the backup in our list
        fetch('/api/backups/list')
            .then(r => r.json())
            .then(data => {
                const backup = data.backups.find(b => b.filename === filename);
                if (backup) {
                    renderBackupDetails(backup);
                } else {
                    document.getElementById('backupDetails').innerHTML = 
                        '<div class="alert alert-error">Backup not found</div>';
                }
            });
    }
    
    function renderBackupDetails(backup) {
        const manifest = backup.manifest || {};
        const contents = manifest.contents || {};
        const files = manifest.files || [];
        
        const html = `
            <div class="details-grid">
                <span class="details-label">Filename:</span>
                <span class="details-value">${backup.filename}</span>
                
                <span class="details-label">Size:</span>
                <span class="details-value">${backup.size_human}</span>
                
                <span class="details-label">Created:</span>
                <span class="details-value">${new Date(backup.created).toLocaleString()}</span>
                
                <span class="details-label">Hostname:</span>
                <span class="details-value">${manifest.hostname || 'Unknown'}</span>
                
                <span class="details-label">Contents:</span>
                <span class="details-value">
                    ${contents.certificates ? 'âœ… Certificates' : 'âŒ Certificates'}<br>
                    ${contents.config ? 'âœ… Configuration' : 'âŒ Configuration'}<br>
                    ${contents.database ? 'âœ… Database' : 'âŒ Database'}<br>
                    ${contents.packages ? 'âœ… Data Packages' : 'âŒ Data Packages'}
                </span>
                
                <span class="details-label">Files:</span>
                <span class="details-value">${files.length} files</span>
            </div>
            
            ${files.length > 0 ? `
                <h4>File List:</h4>
                <div class="file-list">
                    ${files.map(f => `<div>${f}</div>`).join('')}
                </div>
            ` : ''}
        `;
        
        document.getElementById('backupDetails').innerHTML = html;
    }
</script>
{% endblock %}
